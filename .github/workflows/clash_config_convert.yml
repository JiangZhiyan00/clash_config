name: è½¬æ¢Clashé…ç½®å¹¶æäº¤

on:
  push:
    paths:
      - "config.yml"
      - ".github/workflows/clash_config_convert.yml"
      - "clash/converter/global.js"
  workflow_dispatch:

jobs:
  convert-and-commit:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "lts/*"

      - name: å®‰è£…ä¾èµ–
        run: npm install
        working-directory: ./clash/converter

      - name: åˆ›å»ºè¾“å‡ºç›®å½•
        run: mkdir -p clash/converter/dist

      - name: è½¬æ¢é…ç½®æ–‡ä»¶
        run: node clash/converter/convert.js config.yml clash/converter/dist/config_converted.yml

      - name: æäº¤è½¬æ¢åçš„æ–‡ä»¶
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add clash/converter/dist/config_converted.yml
          git diff --quiet && git diff --staged --quiet || git commit -m "ğŸš€ è‡ªåŠ¨æ›´æ–°è½¬æ¢åçš„é…ç½®æ–‡ä»¶"
          git push

      - name: åˆ·æ–° CDN ç¼“å­˜
        run: |
          BRANCH="${{ github.ref_name }}"
          curl -X GET "https://purge.jsdelivr.net/gh/JiangZhiyan00/clash_config@${BRANCH}/clash/converter/dist/config_converted.yml"
          curl -X GET "https://purge.jsdelivr.net/npm/JiangZhiyan00/clash_config@${BRANCH}/clash/converter/dist/config_converted.yml"
