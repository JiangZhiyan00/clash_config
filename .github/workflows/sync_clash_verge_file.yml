name: 同步 Clash Verge 最新版

on:
  schedule:
    - cron: "0 4 * * *" # 每天 UTC 4 点执行一次（北京时间 12 点）
  workflow_dispatch: # 支持手动触发

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: 安装工具 jq & curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: 获取 latest.json
        run: |
          curl -L -o latest.json https://github.com/clash-verge-rev/clash-verge-rev/releases/latest/download/latest.json
          cat latest.json

      - name: 解析版本号
        id: version
        run: |
          VERSION=$(jq -r '.version' latest.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: 恢复上次版本号
        id: cache-restore
        uses: actions/cache@v4
        with:
          path: .last_version
          key: clash-verge-version

      - name: 读取上次版本号
        id: prev
        run: |
          PREV_VERSION=$(cat .last_version 2>/dev/null || echo "none")
          echo "prev=$PREV_VERSION" >> $GITHUB_OUTPUT

      - name: 比较版本号
        id: compare
        run: |
          if [ "${{ steps.version.outputs.version }}" = "${{ steps.prev.outputs.prev }}" ]; then
            echo "changed=false" >> $GITHUB_OUTPUT
          else
            echo "changed=true" >> $GITHUB_OUTPUT
          fi

      - name: 无更新时退出
        if: steps.compare.outputs.changed == 'false'
        run: echo "没有新版本，跳过任务。"

      - name: 下载新版安装包
        if: steps.compare.outputs.changed == 'true'
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BASE_URL="https://github.com/clash-verge-rev/clash-verge-rev/releases/download/$VERSION"
          curl -L -o clash_verge_windows.exe   "$BASE_URL/Clash.Verge_${VERSION}_x64-setup.exe"
          curl -L -o clash_verge_mac_intel.dmg "$BASE_URL/Clash.Verge_${VERSION}_x64.dmg"
          curl -L -o clash_verge_mac_M.dmg     "$BASE_URL/Clash.Verge_${VERSION}_aarch64.dmg"

      - name: 上传到 WebDAV（重试5次）
        if: steps.compare.outputs.changed == 'true'
        run: |
          for FILE in clash_verge_*; do
            for i in {1..5}; do
              echo "上传 $FILE (第 $i 次尝试)..."
              curl -T "$FILE" -u "${{ secrets.WEBDAV_USER }}:${{ secrets.WEBDAV_PASS }}" "https://webdav.opendoc.dpdns.org/$FILE" && break
              echo "上传失败，重试中..."
              sleep 5
            done
          done

      - name: 保存新版本号到 cache
        if: steps.compare.outputs.changed == 'true'
        run: |
          echo "${{ steps.version.outputs.version }}" > .last_version
